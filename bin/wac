#!/bin/bash
#
# /Users/rbe/project/wac2/wac
# 
# Copyright (C) 2010 Informationssysteme Ralf Bensmann.
# Nutzungslizenz siehe http://www.bensmann.com/BPL_v10_de.html
# Use is subject to license terms, see http://www.bensmann.com/BPL_v10_en.html
# 
# Created by: rbe
#

# Operating system
OS=$(uname -s)

# Installation directory
case "${OS}" in
	Darwin)
		# Make an educated guess
		OOO_HOME=${OOO_HOME:-/Applications/OpenOffice.org.app/Contents}
		if [ ! -d ${OOO_HOME} ]; then
			# Oracle Open Office?
			OOO_HOME=${OOO_HOME:-/Applications/Oracle\ Open\ Office.app/Contents}
		fi
		# MacOS X: Don't use program link
		# http://www.openoffice.org/issues/show_bug.cgi?id=101203
		OOO_PROGRAM=${OOO_HOME}/MacOS
	;;
	Linux)
		# Where is OpenOffice?
		OOO_HOME=
		for dir in /usr/lib /opt
		do
			[ -d ${dir}/openoffice ] && OOO_HOME=${dir}; break
			[ -d ${dir}/openoffice.org3 ] && OOO_HOME=${dir}; break
		done
		OOO_PROGRAM=${OOO_HOME}/program
		# Set JAVA_HOME
		JAVA_HOME=${OS}/jre6
		export JAVA_HOME
		PATH=${JAVA_HOME}/bin:${PATH}
		export PATH
	;;
esac

# Libraries
OOOJ="${OOO_HOME}/basis-link/ure-link/share/java"
OOOU="${OOO_HOME}/basis-link/program/classes"
OOOL="${OOO_HOME}/basis-link/program:${OOO_HOME}/basis-link/program/components:${OOO_HOME}/basis-link/ure-link/lib"

# Set UNO path
UNO_PATH="${OOO_PROGRAM}"
export UNO_PATH

# Copy juh.jar into program folder
# http://user.services.openoffice.org/en/forum/viewtopic.php?f=44&t=10825
if [ ! -f ${OOO_PROGRAM}/juh.jar ]; then
        cp ${OOOJ}/juh.jar ${OOO_PROGRAM}
fi

# Classpath
for jar in lib/*
do
	exclude=0
	for ex in juh.jar jurt.jar ridl.jar unoil.jar
	do
		if [ ${jar} == ${ex} ]; then
			exclude=1
			break
		fi
	done
	[ ${exclude} -eq 0 ] && LIB_CLASSPATH="${LIB_CLASSPATH}:${jar}"
done
# Skip first colon
LIB_CLASSPATH=$(echo ${LIB_CLASSPATH} | cut -c 2-)
CLASSPATH="${OOO_PROGRAM}/juh.jar:${OOOJ}/jurt.jar:${OOOJ}/ridl.jar:${OOOU}/unoil.jar:${LIB_CLASSPATH}"
export CLASSPATH

# No OpenOffice running
case "${OS}" in
	Darwin | Linux | *BSD)
		killall soffice 2>/dev/null 1>&2
	;;
	SunOS)
		pkill soffice 2>/dev/null 1>&2
	;;
esac

# Update
mv update/conf/* conf 2>wac.log 1>&2
mv update/lib/* lib 2>>wac.log 1>&2
mv update/sql/* sql 2>>wac.log 1>&2
rm -rf update 2>>wac.log 1>&2

# Start
java -cp "${CLASSPATH}" -Djava.library.path="${OOOL}" -d32 griffon.swing.SwingApplication 2>>wac.log 1>&2

exit 0
