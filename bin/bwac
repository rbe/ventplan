#!/bin/bash
# 
# /Users/rbe/project/wac2/bwac
# 
# Copyright (C) 2010 Informationssysteme Ralf Bensmann.
# Nutzungslizenz siehe http://www.bensmann.com/BPL_v10_de.html
# Use is subject to license terms, see http://www.bensmann.com/BPL_v10_en.html
# 
# Created by: rbe
# 

# Base
USBSTICK=usbstick/wac

#
# Parse application version
#
_parse_version() {
	echo "$(grep app.version application.properties | awk -F= '{print $2}' | sed 's#\.# #g')"
}

#
# Increase actual Griffon application version.
#
_inc_version() {
	version=($(_parse_version))
	maj=${version[0]}
	min=${version[1]}
	pat=${version[2]}
	# Increase depending on parameter(s)
	for i in $*
	do
		eval "$i=$((i + 1))"
	done
	echo "${maj}.${min}.${pat}"
}

#
# Make update directory for actual version.
#
_make_update_dir() {
	version=($(_parse_version))
	maj=${version[0]}
	min=${version[1]}
	pat=${version[2]}
	# Create update directory for actual version
	u=wacupdate/upd${maj}${min}${pat}
	for d in conf lib sql
	do
		mkdir -p ${u}/${d}
	done
}

#
# Set next Griffon application version.
#
_set_next_version() {
	# Make update directory for actual version; before version number is increased
	_make_update_dir
	# Set Griffon application version
	nver=$(_inc_version $1)
	griffon set-version ${nver}
	# Parse new version number
	version=($(_parse_version))
	maj=${version[0]}
	min=${version[1]}
	pat=${version[2]}
	##t=tmp.$$
	##cat application.properties | sed "s#app.version.*#app.version=$maj.$min.$pat#g" > ${t}
	##mv ${t} application.properties
	# Copy next version into update directory
	u=wacupdate/upd${maj}${min}${pat}
	for i in conf lib sql
	do
		mkdir -p ${u}/${i}
	done
	echo "${maj}.${min}.${pat}" > ${u}/conf/version
	#
	echo "New version is ${nver}"
}

#
# Set actual Griffon application version in conf/version.
#
_conf_ver() {
	cat application.properties | grep app.version | awk -F= '{print $2}' > ${USBSTICK}/conf/version
}

#
# Build Odisee
#
_build_odisee() {
	if [ -d ../odisee ]; then
		echo "Building Odisee... see bwac.log"
		pushd ../odisee 2>/dev/null 1>&2
		bin/gbuild jar 2>>bwac.log 1>&2
		popd 2>/dev/null 1>&2
		# Copy Odisee jar into lib folder
		cp ../odisee/dist/odisee.jar lib 2>/dev/null 1>&2
	fi
}

#
# Build grootils
#
_build_grootils() {
	if [ -d ../grootils ]; then
		echo "Building grootils... see bwac.log"
		pushd ../grootils 2>/dev/null 1>&2
		bin/gbuild jar 2>>bwac.log 1>&2
		popd 2>/dev/null 1>&2
		# Copy Odisee jar into lib folder
		cp ../grootils/dist/grootils.jar lib 2>/dev/null 1>&2
	fi
}

#
# 
#
_build_wac() {
	echo "Building WAC..."
	griffon clean 2>/dev/null 1>&2
	echo "Packaging WAC... see bwac.log"
	griffon package 2>>bwac.log 1>&2
}

#
# Make directories for USB stick
#
_usbstick_make_dirs() {
    # OS
    mkdir -p ${USBSTICK}/../mac/wac/Darwin/jre6 2>/dev/null
    mkdir -p ${USBSTICK}/../linux/wac/Linux/jre6 2>/dev/null
    mkdir -p ${USBSTICK}/../win/wac/Windows/jre6 2>/dev/null
    # Software
	for dir in conf lib update
	do
		mkdir -p ${USBSTICK}/${dir}
	done
	# Windows: OOo Portable
	ooo=${USBSTICK}/../win/wac/Windows/OpenOfficePortable
	[ ! -d ${ooo} ] && mkdir -p ${ooo} 2>/dev/null
}

#
# Update SQL database in USB stick distribution
#
_usbstick_update_sql() {
	# Create ZIP backup of database
	cd sql
    java -cp ../lib/h2*.jar org.h2.tools.Recover -db westawac
    java -cp ../lib/h2*.jar org.h2.tools.Backup -file dtmp.zip -db westawac
    for os in linux mac win
    do
        dest=${USBSTICK}/../${os}/wac/lib
        mkdir -p ${dest}
        cp -v dtmp.zip ${dest}
    done
    cp -v dtmp.zip ${USBSTICK}/lib
	cd ..
}

#
# Make USB stick distribution
#
_usbstick() {
	# Make directories
	_usbstick_make_dirs
	# Build Odisee
	_build_odisee
	# Build WAC
	_build_wac
	r=$?
	if [ $r -gt 0 ]; then
		echo "Build unsuccessful, see bwac.log"
		exit $r
	fi
	# Copy jar into lib folder
	rm -rf ${USBSTICK}/lib/*
	cp -v dist/zip/lib/* ${USBSTICK}/lib 2>/dev/null 1>&2
	# Copy start scripts
	for os in linux mac
	do
	    cp -v bin/wac ${USBSTICK}/../${os}/wac
	done
    cp -v bin/wac.bat ${USBSTICK}/../win/wac
	# SQL?
	if [ ! -d ${USBSTICK}/lib/dtmp.zip ]; then
		_usbstick_update_sql
	fi
	# Version
	_conf_ver
	#
	echo "Done"
}

rm bwac.log
case "$1" in
	inc-version)
		if [ $# -lt 2 ]; then
			echo "inc-version needs parameter: <maj | min | pat>"
			exit 1
		fi
		_set_next_version $2
	;;
	usbstick)
		_usbstick
	;;
	usbstick-sql)
		_usbstick_update_sql
	;;
	distrib)
		_usbstick
		_usbstick_update_sql
    ;;
	*)
		echo "usage: $0 { usbstick | usbstick-sql | distrib | inc-version <maj | min | pat> }"
	;;
esac

exit 0
